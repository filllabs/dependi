import { ExtensionContext, ProgressLocation, commands, window } from "vscode";
import { Configs } from "../../config";
import { generateMainReport } from "./reportGenerator";
import { VulnerabilityReportPanel } from "../../panels/VulnerabilityReportPanel";

/**
 * 
 * @param context 
 * Generate the vulnerability report for the current repository and active file. Creates a WebView panel to display the report.
 * @returns 
 */
export const generateVulnerabilityReport = (context: ExtensionContext) =>
  commands.registerCommand(Configs.GENERATE_VULNERABILITY_REPORT, async () => {
    const progressOptions = {
      location: ProgressLocation.Notification,
      title: "Loading Report",
      cancellable: false,
    };

    window.withProgress(progressOptions, generateMainReport).then(
      (fetchedHTML) => {
        if (!fetchedHTML) {
          return;
        }
        VulnerabilityReportPanel.render(context.extensionUri, fetchedHTML);
      },
      (error) => {
        window.showErrorMessage(`Report generation failed: ${error}`);
      }
    );
  });
